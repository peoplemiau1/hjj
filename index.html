<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DeadChannel_v2</title>
<style>
    :root {
        --bg-primary: #0e1621;
        --bg-header: #17212b;
        --msg-in: #182533;
        --msg-out: #2b5278;
        --text-main: #f5f5f5;
        --text-sub: #6c7883;
        --accent: #64b5ef;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        background-color: var(--bg-primary);
        color: var(--text-main);
        font-family: var(--font);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        cursor: default;
    }

    .overlay-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;
        display: none;
    }

    #glitch-fx {
        background: rgba(255, 0, 0, 0.1);
        mix-blend-mode: exclusion;
    }

    #whiteout-fx {
        background: #fff;
        z-index: 200;
        opacity: 0;
        transition: opacity 4s ease-in;
        display: block;
        pointer-events: none;
    }

    #screamer-fx {
        background: #000;
        z-index: 150;
        display: none;
        align-items: center; justify-content: center;
    }
    
    .screamer-content { font-size: 8rem; animation: shake 0.1s infinite; }

    header {
        background: var(--bg-header);
        padding: 10px 15px;
        display: flex;
        align-items: center;
        z-index: 10;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .avatar-group {
        width: 42px; height: 42px;
        background: linear-gradient(135deg, #444, #222);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; margin-right: 12px;
        position: relative;
    }

    .avatar-group::after {
        content: ''; position: absolute; bottom: 0; right: 0;
        width: 10px; height: 10px; background: #f55;
        border: 2px solid var(--bg-header); border-radius: 50%;
    }

    .meta h3 { font-size: 16px; font-weight: 600; }
    .meta p { font-size: 13px; color: var(--text-sub); margin-top: 2px; }

    #viewport {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: url('https://web.telegram.org/img/bg_0.png');
        background-blend-mode: multiply;
        background-color: var(--bg-primary);
        display: flex; flex-direction: column; gap: 6px;
    }

    .msg-row { display: flex; width: 100%; animation: fade 0.2s ease; }
    .msg-row.me { justify-content: flex-end; }
    
    .msg-bubble {
        max-width: 75%; padding: 6px 10px;
        border-radius: 8px; position: relative;
        font-size: 15px; line-height: 1.3;
        box-shadow: 0 1px 1px rgba(0,0,0,0.3);
    }

    .me .msg-bubble { background: var(--msg-out); border-bottom-right-radius: 0; }
    .other .msg-bubble { background: var(--msg-in); border-bottom-left-radius: 0; }
    
    .sender-ref {
        font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;
    }
    
    .time-ref {
        float: right; font-size: 11px; color: var(--text-sub);
        margin-left: 8px; margin-top: 6px;
    }

    .c-alex { color: #64b5ef; }
    .c-katya { color: #d866ff; }
    .c-dan { color: #eebb55; }
    .c-monster { color: #f55; }

    .controls {
        background: var(--bg-header);
        padding: 10px; display: flex; align-items: flex-end; z-index: 20;
    }

    #msg-input {
        flex: 1; background: #000; border: none;
        padding: 12px; border-radius: 18px;
        color: #fff; font-family: inherit; font-size: 15px;
        outline: none;
    }

    #send-btn {
        background: var(--accent); border: none;
        width: 42px; height: 42px; border-radius: 50%;
        margin-left: 10px; cursor: pointer;
        color: #fff; font-size: 18px; display: flex; align-items: center; justify-content: center;
    }

    @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
</style>
</head>
<body>

<div id="glitch-fx" class="overlay-layer"></div>
<div id="screamer-fx" class="overlay-layer"><div class="screamer-content">‚ò†Ô∏è</div></div>
<div id="whiteout-fx" class="overlay-layer"></div>

<header>
    <div class="avatar-group">SOS</div>
    <div class="meta">
        <h3>–ì–ª—É—Ö–∞—è –ì–∞—Ç—å</h3>
        <p id="status-label">—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</p>
    </div>
</header>

<div id="viewport"></div>

<div class="controls">
    <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." autocomplete="off">
    <button id="send-btn">‚û§</button>
</div>

<script>
class AudioEngine {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }

    ensureActive() {
        if (this.ctx.state === 'suspended') this.ctx.resume();
    }

    play(type) {
        this.ensureActive();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        if (type === 'msg') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.05);
        } else if (type === 'scare') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(50, this.ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(800, this.ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.4);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.4);
        }
    }
}

class UIManager {
    constructor() {
        this.view = document.getElementById('viewport');
        this.status = document.getElementById('status-label');
        this.input = document.getElementById('msg-input');
        this.glitchEl = document.getElementById('glitch-fx');
        this.screamerEl = document.getElementById('screamer-fx');
        this.whiteoutEl = document.getElementById('whiteout-fx');
    }

    renderMessage(msg) {
        const row = document.createElement('div');
        row.className = `msg-row ${msg.isUser ? 'me' : 'other'}`;

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';

        if (!msg.isUser) {
            const name = document.createElement('span');
            name.className = `sender-ref c-${msg.agentId}`;
            name.innerText = msg.name;
            bubble.appendChild(name);
        }

        const text = document.createElement('span');
        text.innerText = msg.text;
        bubble.appendChild(text);

        const time = document.createElement('span');
        time.className = 'time-ref';
        const now = new Date();
        time.innerText = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        bubble.appendChild(time);

        row.appendChild(bubble);
        this.view.appendChild(row);
        this.view.scrollTop = this.view.scrollHeight;
    }

    setStatus(text) {
        this.status.innerText = text;
    }

    triggerGlitch() {
        this.glitchEl.style.display = 'block';
        setTimeout(() => this.glitchEl.style.display = 'none', 200);
    }

    triggerScreamer() {
        this.screamerEl.style.display = 'flex';
        this.screamerEl.querySelector('.screamer-content').innerText = Math.random() > 0.5 ? 'üëÅ' : 'ü©∏';
        setTimeout(() => this.screamerEl.style.display = 'none', 150);
    }

    triggerFinalLight() {
        this.whiteoutEl.style.opacity = '1';
    }

    clearInput() {
        const val = this.input.value;
        this.input.value = '';
        return val.trim();
    }
}

class APIClient {
    constructor(apiKey) {
        this.key = apiKey;
        this.url = "https://openrouter.ai/api/v1/chat/completions";
    }

    async fetchResponse(messages, temp) {
        try {
            const response = await fetch(this.url, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${this.key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "openrouter/sherlock-think-alpha",
                    messages: messages,
                    temperature: temp,
                    max_tokens: 150
                })
            });
            const data = await response.json();
            return data.choices?.[0]?.message?.content || "...";
        } catch (e) {
            console.error(e);
            return "...";
        }
    }
}

class Agent {
    constructor(id, name, systemPrompt, temp = 0.7) {
        this.id = id;
        this.name = name;
        this.system = systemPrompt;
        this.temp = temp;
    }

    async generateReply(client, globalContext) {
        const messages = [
            { role: "system", content: this.system },
            ...globalContext.slice(-15)
        ];
        return await client.fetchResponse(messages, this.temp);
    }
}

class App {
    constructor() {
        this.ui = new UIManager();
        this.audio = new AudioEngine();
        this.client = new APIClient("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");
        
        this.history = [];
        this.agents = {
            alex: new Agent('alex', '–ê–ª–µ–∫—Å', "–¢—ã –ê–ª–µ–∫—Å. –õ–∏–¥–µ—Ä –≥—Ä—É–ø–ø—ã. –°—Ç–∞—Ä–∞–µ—à—å—Å—è –±—ã—Ç—å —Å–ø–æ–∫–æ–π–Ω—ã–º. –ü–∏—à–µ—à—å –∫—Ä–∞—Ç–∫–æ."),
            katya: new Agent('katya', '–ö–∞—Ç—è', "–¢—ã –ö–∞—Ç—è. –°–∫–µ–ø—Ç–∏–∫, –∏—â–µ—à—å –ª–æ–≥–∏–∫—É, –Ω–æ –±–æ–∏—à—å—Å—è."),
            dan: new Agent('dan', '–î—ç–Ω', "–¢—ã –î—ç–Ω. –ü–∞–Ω–∏–∫–µ—Ä. –í–∏–¥–∏—à—å –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏. –ü–ò–®–ï–®–¨ –ö–ê–ü–°–û–ú –ò –í–û–°–ö–õ–ò–¶–ê–ù–ò–Ø–ú–ò!"),
            monster: new Agent('monster', '–•–û–ó–Ø–ò–ù', "–¢—ã –ó–ª–æ –ë–æ–ª–æ—Ç–∞. –¢–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã: [GLITCH], [SCREAM], [LIGHT]. –ü—É–≥–∞–π.", 1.0)
        };

        this.bindEvents();
        this.startSimulation();
    }

    bindEvents() {
        document.getElementById('send-btn').addEventListener('click', () => this.handleUserAction());
        document.getElementById('msg-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') this.handleUserAction();
        });
    }

    startSimulation() {
        setTimeout(() => this.injectMessage('alex', '–°–≤—è–∑—å –µ—Å—Ç—å? –í—ã –≥–¥–µ?'), 1000);
    }

    injectMessage(agentId, text) {
        this.ui.renderMessage({ isUser: false, name: this.agents[agentId].name, agentId: agentId, text: text });
        this.history.push({ role: "assistant", name: this.agents[agentId].name, content: text });
        this.audio.play(agentId === 'monster' ? 'scare' : 'msg');
    }

    async handleUserAction() {
        const text = this.ui.clearInput();
        if (!text) return;

        this.ui.renderMessage({ isUser: true, text: text });
        this.history.push({ role: "user", content: `–ò–≥—Ä–æ–∫: ${text}` });

        const responders = this.selectResponders(text);
        
        let delayOffset = 1000;
        responders.forEach(id => {
            setTimeout(() => this.triggerAgent(id), delayOffset);
            delayOffset += Math.random() * 2000 + 1500;
        });

        if (Math.random() > 0.65 || text.length > 20) {
            setTimeout(() => this.triggerAgent('monster'), delayOffset + 1000);
        }
    }

    selectResponders(input) {
        const low = input.toLowerCase();
        const list = [];
        if (low.includes('–∞–ª–µ–∫—Å')) list.push('alex');
        if (low.includes('–∫–∞—Ç')) list.push('katya');
        if (low.includes('–¥—ç–Ω')) list.push('dan');
        
        if (list.length === 0) {
            const keys = ['alex', 'katya', 'dan'];
            const count = Math.random() > 0.5 ? 2 : 1;
            for(let i=0; i<count; i++) list.push(keys[Math.floor(Math.random()*keys.length)]);
        }
        return [...new Set(list)];
    }

    async triggerAgent(id) {
        this.ui.setStatus(`${this.agents[id].name} –ø–µ—á–∞—Ç–∞–µ—Ç...`);
        const raw = await this.agents[id].generateReply(this.client, this.history);
        this.ui.setStatus('–≤ —Å–µ—Ç–∏');
        this.processResponse(id, raw);
    }

    processResponse(id, text) {
        let cleanText = text;
        if (id === 'monster') {
            if (text.includes('[GLITCH]')) {
                this.ui.triggerGlitch();
                cleanText = cleanText.replace('[GLITCH]', '');
            }
            if (text.includes('[SCREAM]')) {
                this.ui.triggerScreamer();
                cleanText = cleanText.replace('[SCREAM]', '');
            }
            if (text.includes('[LIGHT]')) {
                this.ui.triggerFinalLight();
                cleanText = "–ö–û–ù–ï–¶ –°–í–Ø–ó–ò";
            }
        }
        if (cleanText.trim().length > 0) {
            this.injectMessage(id, cleanText);
        }
    }
}

window.onload = () => new App();
</script>
</body>
</html>
