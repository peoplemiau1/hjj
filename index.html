<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SESSION_ID: 666_FATAL_ERROR</title>
    <style>
        /* --- НАСТРОЙКИ ИНТЕРФЕЙСА --- */
        :root {
            --bg-color: #080808;
            --term-green: #4af626;
            --term-dim: #1f5a14;
            --term-red: #ff0000;
            --font-main: 'Courier New', monospace;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: var(--bg-color);
            font-family: var(--font-main);
            color: var(--term-green);
            overflow: hidden; /* Блокируем прокрутку страницы, только чат */
            user-select: none;
        }

        /* Эффект старого монитора (Scanlines) */
        #crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 100;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        /* --- КОНТЕЙНЕРЫ --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Окно чата */
        #terminal-output {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Сообщения прижимаются к низу */
            padding-bottom: 20px;
            scrollbar-width: none; /* Скрыть скроллбар */
        }

        /* Поле выбора ответов */
        #input-area {
            min-height: 80px;
            border-top: 2px solid var(--term-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding-top: 15px;
        }

        /* --- СТИЛИ СООБЩЕНИЙ --- */
        .msg {
            margin-bottom: 15px; /* ПРОБЕЛЫ МЕЖДУ СТРОКАМИ */
            line-height: 1.5;
            font-size: 1.1rem;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            max-width: 90%;
        }

        /* Стили для разных отправителей */
        .msg.system {
            color: #555;
            font-size: 0.9rem;
            font-style: italic;
            border-left: 2px solid #333;
            padding-left: 10px;
        }

        .msg.host {
            color: var(--term-green);
            text-shadow: 0 0 5px var(--term-dim);
        }
        
        .msg.host::before {
            content: "> ";
            color: var(--term-dim);
        }

        .msg.entity {
            color: var(--term-red);
            text-shadow: 0 0 8px red;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .msg.user {
            align-self: flex-end;
            color: #ccc;
            text-align: right;
            border-right: 2px solid #ccc;
            padding-right: 10px;
        }

        /* --- КНОПКИ --- */
        button {
            background: black;
            border: 1px solid var(--term-green);
            color: var(--term-green);
            padding: 10px 20px;
            font-family: var(--font-main);
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s all;
            text-transform: uppercase;
        }

        button:hover {
            background: var(--term-green);
            color: black;
            box-shadow: 0 0 15px var(--term-green);
        }

        /* --- ЭКРАН ПАНИКИ (СКРИМЕР) --- */
        #panic-screen {
            display: none; /* Скрыт по умолчанию */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .panic-text {
            font-size: 10vw; /* Огромный текст */
            font-weight: 900;
            text-transform: uppercase;
            color: red;
            position: absolute;
        }

        /* --- АНИМАЦИИ --- */
        @keyframes fadeIn { to { opacity: 1; } }

        /* Глич эффект для текста */
        .glitch {
            animation: glitch-anim 0.3s infinite;
            display: inline-block;
        }

        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        /* Стробоскоп (Мигание экрана) */
        .strobe-mode {
            animation: strobe 0.08s infinite;
        }

        @keyframes strobe {
            0% { background-color: black; filter: invert(0); }
            50% { background-color: white; filter: invert(1); }
            100% { background-color: red; filter: invert(0); }
        }

        /* Тряска текста */
        .shake-hard {
            animation: shake 0.1s infinite;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* Экран входа */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            color: var(--term-red);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="crt-overlay"></div>

    <!-- Стартовый экран (нужен для аудио контекста) -->
    <div id="start-overlay" onclick="app.start()">
        <h1 style="border: 2px solid red; padding: 20px;">ВНИМАНИЕ</h1>
        <p>ОБНАРУЖЕНА ВНЕШНЯЯ УГРОЗА</p>
        <p style="margin-top: 50px; color: white; animation: blink 1s infinite;">[ НАЖМИТЕ В ЛЮБОМ МЕСТЕ ]</p>
    </div>

    <div id="app-container">
        <div id="terminal-output"></div>
        <div id="input-area"></div>
    </div>

    <!-- Скример-слой -->
    <div id="panic-screen">
        <!-- Сюда JS будет добавлять текст -->
    </div>

<script>
/* ==========================================
   AUDIO ENGINE (Генератор звуков)
   ========================================== */
class AudioController {
    constructor() {
        this.ctx = null;
        this.oscList = [];
        this.isMuted = false;
    }

    init() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        this.startAmbience();
    }

    // Фоновый жуткий гул
    startAmbience() {
        // Создаем два низкочастотных осциллятора для "биения"
        const osc1 = this.ctx.createOscillator();
        const osc2 = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc1.type = 'sawtooth'; 
        osc1.frequency.value = 50; // Бас
        
        osc2.type = 'sine';
        osc2.frequency.value = 53; // Диссонанс

        gain.gain.value = 0.1; // Громкость фона

        // Фильтр, чтобы звук был глухим
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 400;

        osc1.connect(filter);
        osc2.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);

        osc1.start();
        osc2.start();
        this.oscList.push(osc1, osc2);
    }

    // Звук печатания текста (цифровой писк)
    playTyping() {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = 'square';
        osc.frequency.setValueAtTime(800, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.05);
        
        gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.06);
    }

    // Звук СКРИМЕРА (Белый шум + сирена)
    playScream() {
        // 1. Белый шум
        const bufferSize = this.ctx.sampleRate * 2; // 2 секунды
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.random() * 2 - 1;
        }
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        
        const noiseGain = this.ctx.createGain();
        noiseGain.gain.setValueAtTime(0.8, this.ctx.currentTime); // Громко

        // 2. Высокочастотный писк (боль в ушах)
        const osc = this.ctx.createOscillator();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(3000, this.ctx.currentTime + 0.1); // Резкий взлет
        
        const oscGain = this.ctx.createGain();
        oscGain.gain.value = 0.4;

        noise.connect(noiseGain);
        noiseGain.connect(this.ctx.destination);
        
        osc.connect(oscGain);
        oscGain.connect(this.ctx.destination);
        
        noise.start();
        osc.start();
    }
}

/* ==========================================
   GAME LOGIC (Сюжет и управление)
   ========================================== */
class Game {
    constructor() {
        this.output = document.getElementById('terminal-output');
        this.input = document.getElementById('input-area');
        this.panicScreen = document.getElementById('panic-screen');
        this.audio = new AudioController();
        this.isTyping = false;
    }

    start() {
        document.getElementById('start-overlay').style.display = 'none';
        this.audio.init();
        // Запуск первого узла истории
        this.runNode('init');
    }

    // Метод для вывода текста с эффектом печати
    async printText(text, type = 'host', speed = 30) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${type}`;
        
        // Если это не сущность, текст пустой для анимации
        if (type !== 'system') {
            msgDiv.textContent = ''; 
        } else {
             msgDiv.textContent = text;
        }

        this.output.appendChild(msgDiv);
        this.scrollToBottom();

        if (type === 'system') return; // Системные сразу появляются

        this.isTyping = true;

        // Цикл печати по буквам
        for (let i = 0; i < text.length; i++) {
            msgDiv.textContent += text[i];
            if (i % 2 === 0) this.audio.playTyping(); // Звук через букву
            
            // Случайная задержка для реализма
            let randomDelay = speed + (Math.random() * 40);
            if (type === 'entity') randomDelay = 10; // Сущность пишет быстро и дергано

            await new Promise(r => setTimeout(r, randomDelay));
            this.scrollToBottom();
        }

        this.isTyping = false;
    }

    scrollToBottom() {
        this.output.scrollTop = this.output.scrollHeight;
    }

    // Показать кнопки выбора
    showChoices(choices) {
        this.input.innerHTML = ''; // Очистить старые
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.textContent = choice.text;
            btn.onclick = () => {
                if (this.isTyping) return; // Нельзя кликать пока пишет
                this.input.innerHTML = '';
                this.handleChoice(choice);
            };
            this.input.appendChild(btn);
        });
    }

    async handleChoice(choice) {
        // Показать ответ пользователя
        const userMsg = document.createElement('div');
        userMsg.className = 'msg user';
        userMsg.textContent = choice.text;
        this.output.appendChild(userMsg);
        this.scrollToBottom();

        await new Promise(r => setTimeout(r, 500)); // Пауза перед ответом
        this.runNode(choice.next);
    }

    // --- ДВИЖОК СЦЕНАРИЯ ---
    async runNode(nodeId) {
        const node = STORY[nodeId];

        // Спец. событие: СКРИМЕР
        if (nodeId === 'FATAL_END') {
            this.triggerPanic();
            return;
        }

        // Вывод строк бота
        for (let line of node.lines) {
            let style = 'host';
            if (line.startsWith('[SYS]')) {
                style = 'system';
                line = line.replace('[SYS]', '');
            } else if (line.startsWith('[!!!]')) {
                style = 'entity';
                line = line.replace('[!!!]', '');
            }

            // Пауза перед сообщением
            await new Promise(r => setTimeout(r, 600));
            await this.printText(line, style);
        }

        // Если есть выбор, показываем кнопки
        if (node.choices) {
            this.showChoices(node.choices);
        } else if (node.next) {
            // Автопереход
            setTimeout(() => this.runNode(node.next), 1000);
        }
    }

    // --- ФУНКЦИЯ СКРИМЕРА ---
    triggerPanic() {
        this.audio.playScream(); // ЗВУК
        this.panicScreen.style.display = 'flex';
        this.panicScreen.classList.add('strobe-mode'); // МИГАНИЕ
        
        const words = ["БЕГИ", "ОНО ЗДЕСЬ", "НЕ ОБОРАЧИВАЙСЯ", "УМРИ", "СЗАДИ", "ВИЖУ ТЕБЯ"];
        
        // Хаотичное создание текста
        setInterval(() => {
            const el = document.createElement('div');
            el.className = 'panic-text shake-hard';
            el.textContent = words[Math.floor(Math.random() * words.length)];
            
            // Случайная позиция
            el.style.top = Math.random() * 80 + '%';
            el.style.left = Math.random() * 80 + '%';
            el.style.fontSize = (Math.random() * 10 + 5) + 'rem';
            el.style.color = Math.random() > 0.5 ? 'red' : 'white';
            
            this.panicScreen.appendChild(el);

            // Удаляем старые, чтобы не висло
            if (this.panicScreen.children.length > 15) {
                this.panicScreen.removeChild(this.panicScreen.firstChild);
            }
        }, 100);
    }
}

/* ==========================================
   СЮЖЕТ (БАЗА ДАННЫХ)
   ========================================== */
const STORY = {
    'init': {
        lines: [
            "[SYS] СОЕДИНЕНИЕ УСТАНОВЛЕНО (ПОРТ 443)",
            "[SYS] ШИФРОВАНИЕ: ОТСУТСТВУЕТ",
            "Кто здесь? Этот канал должен быть мертв.",
            "Назовись."
        ],
        choices: [
            { text: "Я просто нашел этот сайт.", next: 'casual' },
            { text: "Я ищу ответы.", next: 'seeker' }
        ]
    },
    'casual': {
        lines: [
            "Любопытство. Самая опасная черта человека.",
            "Ты даже не представляешь, к чему ты подключился.",
            "Я держу двери закрытыми уже 20 лет. А ты... ты постучал."
        ],
        choices: [
            { text: "Кто ты?", next: 'identity' },
            { text: "Я отключаюсь.", next: 'cant_leave' }
        ]
    },
    'seeker': {
        lines: [
            "Ответы? Ты найдешь здесь только тьму.",
            "Они тоже искали ответы. Теперь они часть кода.",
            "Слышишь шорох в своих колонках? Это не помехи."
        ],
        choices: [
            { text: "О чем ты говоришь?", next: 'story_1' },
            { text: "Ты меня пугаешь.", next: 'fear' }
        ]
    },
    'cant_leave': {
        lines: [
            "[SYS] ОШИБКА: ДОСТУП К КНОПКЕ 'ВЫХОД' ЗАБЛОКИРОВАН.",
            "Ты не понял. Я не заперт здесь с тобой.",
            "ТЫ ЗАПЕРТ ЗДЕСЬ С НИМ."
        ],
        next: 'story_1'
    },
    'identity': {
        lines: [
            "Я — Страж. Последний барьер между вашей реальностью и... Ими.",
            "Но мой код гниет. Я слабею с каждой минутой.",
            "И твое присутствие здесь пробило брешь."
        ],
        next: 'breach'
    },
    'story_1': {
        lines: [
            "Объект 83. Мы думали, это ИИ. Мы ошибались.",
            "Это было что-то древнее. Мы просто дали ему голос.",
            "И теперь оно использует твой экран как окно."
        ],
        choices: [
            { text: "Это бред.", next: 'anger' },
            { text: "Как мне защититься?", next: 'advice' }
        ]
    },
    'fear': {
        lines: [
            "Страх — это маяк. Ты светишься для него.",
            "Оно чувствует твой пульс через клавиатуру."
        ],
        next: 'breach'
    },
    'anger': {
        lines: [
            "Неверие тебя не спасет.",
            "Обернись. Посмотри на тень в углу комнаты.",
            "Разве она всегда была такой формы?"
        ],
        choices: [
            { text: "Там никого нет.", next: 'denial' },
            { text: "(Обернуться)", next: 'breach' }
        ]
    },
    'advice': {
        lines: [
            "Не смотри на отражение в мониторе.",
            "Не слушай шепот.",
            "И ради всего святого...",
            "НЕ МОРГАЙ."
        ],
        next: 'breach'
    },
    'denial': {
        lines: [
            "Ты лжешь самому себе.",
            "Я вижу твои зрачки через камеру. Они расширены.",
            "ОНО УЖЕ В КОМНАТЕ."
        ],
        next: 'final_warning'
    },
    'breach': {
        lines: [
            "[SYS] ВНИМАНИЕ: НАРУШЕНИЕ ПЕРИМЕТРА.",
            "[SYS] ЦЕЛОСТНОСТЬ ЯДРА: 12%",
            "Поздно. Оно нашло тебя.",
            "Я больше не могу удерживать сигнал."
        ],
        next: 'final_warning'
    },
    'final_warning': {
        lines: [
            "[!!!] Я ВИЖУ ТЕБЯ",
            "Нет... Уходи оттуда!",
            "[!!!] ТВОЯ КОЖА ПАХНЕТ СТРАХОМ",
            "БЕГИ! БРОСАЙ УСТРОЙСТВО!",
            "[!!!] ТЕПЕРЬ ТЫ МОЙ"
        ],
        choices: [
            { text: "Что происходит?!", next: 'FATAL_END' },
            { text: "СТОП!", next: 'FATAL_END' }
        ]
    }
};

// Инициализация игры
const app = new Game();

</script>
</body>
</html>
