<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выживание в Дятлово</title>
    <!-- Подключение Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .bot-message-wrapper { display: flex; align-items: flex-end; gap: 8px; align-self: flex-start; }
        .bot-message { background-color: #262626; color: white; border-bottom-left-radius: 5px; }
        .user-message-wrapper { display: flex; justify-content: flex-end; align-items: flex-end; gap: 8px; align-self: flex-end; }
        .user-message { background-color: #4b5563; color: white; border-bottom-right-radius: 5px; }
        .avatar { width: 40px; height: 40px; border-radius: 9999px; object-fit: cover; }
        
        #action-btn {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            transform: scale(0.8); opacity: 0; pointer-events: none;
        }
        #action-btn.visible { transform: scale(1); opacity: 1; pointer-events: auto; }

        #ai-selector {
            background-color: #2a2a2a; color: white; border: 1px solid #444;
            border-radius: 8px; padding: 4px 8px; cursor: pointer;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
    </style>
</head>
<body>

    <div class="mx-auto flex flex-col h-screen" style="max-width: 450px; background-image: url('https://images.pexels.com/photos/2079667/pexels-photo-2079667.jpeg'); background-size: cover; background-position: center;">

        <!-- 1. Верхняя панель (Header) -->
        <header class="flex items-center justify-between p-3 bg-[#1e1e1e] text-white bg-opacity-80 backdrop-blur-sm flex-shrink-0">
            <div class="flex items-center space-x-3">
                <img id="header-avatar" src="" alt="Аватар ИИ" class="w-8 h-8 rounded-full">
                <span id="header-name" class="font-semibold text-lg"></span>
            </div>
            <div class="flex items-center space-x-4">
                <select id="ai-selector"></select>
            </div>
        </header>

        <!-- 2. Основная часть (Контейнер для сообщений) -->
        <main id="chat-container" class="flex-grow flex flex-col p-4 space-y-4 overflow-y-auto"></main>

        <!-- 3. Нижняя панель (Форма для отправки сообщения) -->
        <footer class="bg-black bg-opacity-80 backdrop-blur-sm p-3">
             <form id="message-form" class="flex items-center space-x-2 pt-1">
                <div class="relative flex-grow">
                    <input type="text" id="message-input" placeholder="Написать сообщение..." class="w-full bg-[#2a2a2a] text-white rounded-full py-2 px-4 focus:outline-none" />
                </div>
                <button type="submit" id="action-btn" class="text-white bg-blue-800 rounded-full p-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" /></svg>
                </button>
            </form>
        </footer>
    </div>

    <script>
        // --- КОНФИГУРАЦИЯ ИИ-ПЕРСОНАЖЕЙ ---
        const AI_AGENTS = {
            'survivor': {
                name: "Лена?",
                // --- ИЗМЕНЕНИЕ ЗДЕСЬ ---
                model: "openrouter/polaris-alpha",
                avatar: "https://placehold.co/40x40/4b5563/FFF?text=Л",
                system_prompt: "Ты — Лена, подруга игрока. Вы вместе приехали в село Дятлово. Ночью на вас напали монстры. Ты смогла убежать и спряталась в подвале старого дома. Ты очень напугана, замерзла, и пишешь игроку в надежде, что он жив. Твои сообщения должны быть короткими, паническими. Спрашивай, где он, слышит ли он крики, и описывай звуки, которые слышишь ты (скрежет наверху, шаги). Твоя цель — найти игрока и выжить."
            },
            'monster': {
                name: "???",
                // --- ИЗМЕНЕНИЕ ЗДЕСЬ ---
                model: "openrouter/polaris-alpha",
                avatar: "https://placehold.co/40x40/7f1d1d/FFF?text=...",
                system_prompt: "Ты — древнее чудовище, обитающее в селе Дятлово. Ты — сама суть этого проклятого места. Ты можешь проникать в радиочастоты и чужие мысли. Ты перехватил сигнал телефона игрока. Твоя цель — играть с ним, мучить его, сводить с ума, прежде чем найти и поглотить. Говори короткими, сломанными фразами. Используй шепот, намеки. Дай понять, что ты всё видишь и слышишь. Например: 'Холодно... в сарае?', 'Слышу... как бьется... сердце...', 'Твои друзья... вкусные...'."
            }
        };

        const USER_AVATAR_URL = "https://placehold.co/40x40/10B981/FFF?text=Я";
        
        let currentAgentId = 'survivor';
        let conversationHistories = {};

        const chatContainer = document.getElementById('chat-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const actionBtn = document.getElementById('action-btn');
        const aiSelector = document.getElementById('ai-selector');

        function initializeApp() {
            Object.keys(AI_AGENTS).forEach(agentId => {
                const agent = AI_AGENTS[agentId];
                const option = document.createElement('option');
                option.value = agentId;
                option.textContent = agent.name;
                aiSelector.appendChild(option);
                conversationHistories[agentId] = [{ role: 'system', content: agent.system_prompt }];
            });
            
            const firstMessageSurvivor = "Ты жив?! Слава богу! Где ты?! Я спряталась в каком-то подвале, тут так темно... Я слышу их, они ходят где-то наверху...";
            conversationHistories['survivor'].push({ role: 'assistant', content: firstMessageSurvivor });
            
            const firstMessageMonster = "...нашел...";
            conversationHistories['monster'].push({ role: 'assistant', content: firstMessageMonster });

            aiSelector.addEventListener('change', (e) => switchAgent(e.target.value));
            
            switchAgent(currentAgentId);
        }

        function switchAgent(agentId) {
            currentAgentId = agentId;
            const agent = AI_AGENTS[agentId];

            document.getElementById('header-avatar').src = agent.avatar;
            document.getElementById('header-name').textContent = agent.name;
            
            chatContainer.innerHTML = '';
            
            conversationHistories[agentId].forEach(msg => {
                if (msg.role === 'user') {
                    addUserMessage(msg.content, false);
                } else if (msg.role === 'assistant') {
                    addBotMessage(msg.content, false);
                }
            });
            scrollToBottom();
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            addUserMessage(messageText);
            conversationHistories[currentAgentId].push({ role: 'user', content: messageText });
            
            messageInput.value = '';
            actionBtn.classList.remove('visible');
            
            showTypingIndicator();

            try {
                const aiResponse = await getAIResponse();
                hideTypingIndicator();
                addBotMessage(aiResponse);
                conversationHistories[currentAgentId].push({ role: 'assistant', content: aiResponse });
            } catch (error) {
                console.error("Ошибка API:", error);
                hideTypingIndicator();
                addBotMessage("...помехи... ничего не слышно...", true);
            }
        });

        async function getAIResponse() {
            // !!! ВАЖНО: Никогда не храните ключ API в клиентском коде для реальных проектов!
            const apiKey = "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";
            const apiUrl = "https://openrouter.ai/api/v1/chat/completions";

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    "model": AI_AGENTS[currentAgentId].model,
                    "messages": conversationHistories[currentAgentId]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Ошибка API: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        messageInput.addEventListener('input', () => {
            actionBtn.classList.toggle('visible', messageInput.value.trim() !== '');
        });

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(text, doScroll = true) {
            const wrapper = document.createElement('div');
            wrapper.className = 'user-message-wrapper';
            wrapper.innerHTML = `<div class="chat-bubble user-message">${text}</div><img src="${USER_AVATAR_URL}" alt="Аватар игрока" class="avatar flex-shrink-0">`;
            chatContainer.appendChild(wrapper);
            if (doScroll) scrollToBottom();
        }

        function addBotMessage(text, doScroll = true) {
            const wrapper = document.createElement('div');
            wrapper.className = 'bot-message-wrapper';
            wrapper.innerHTML = `<img src="${AI_AGENTS[currentAgentId].avatar}" alt="Аватар ИИ" class="avatar flex-shrink-0"><div class="chat-bubble bot-message">${text}</div>`;
            chatContainer.appendChild(wrapper);
            if (doScroll) scrollToBottom();
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'bot-message-wrapper';
            indicator.innerHTML = `<img src="${AI_AGENTS[currentAgentId].avatar}" alt="Аватар ИИ" class="avatar flex-shrink-0"><div class="chat-bubble bot-message">...</div>`;
            chatContainer.appendChild(indicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }
        
        initializeApp();
    </script>

</body>
</html>
