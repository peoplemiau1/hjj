<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<title>ECHO_FOREST_UI_UPDATE</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    :root {
        --bg-color: #000000;
        --header-bg: #1f1f1f;
        --bubble-in: #2b2b2b;
        --bubble-out: #3e70dd;
        --text-color: #ffffff;
        --text-sec: #8e8e8e;
        --input-bg: #1f1f1f;
        --accent: #3e70dd;
        --danger: #ff3b30;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: 'Roboto', sans-serif;
        height: 100vh;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    header {
        flex: 0 0 56px;
        background: var(--header-bg);
        display: flex;
        align-items: center;
        padding: 0 12px;
        color: #fff;
        box-shadow: 0 1px 0 rgba(255,255,255,0.05);
        z-index: 10;
    }
    .icon-btn {
        width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        border-radius: 50%;
    }
    .icon-btn:active { background: rgba(255,255,255,0.1); }
    .icon-svg { width: 24px; height: 24px; fill: #b0b0b0; }
    .header-content {
        flex: 1;
        display: flex;
        align-items: center;
        margin-left: 4px;
        overflow: hidden;
    }
    .header-avatar {
        width: 32px; height: 32px;
        background: #333;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 14px;
        margin-right: 10px;
        color: #ccc;
    }
    .header-text h1 { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-text span { font-size: 12px; color: #888; display: block; }
    #viewport {
        flex: 1;
        overflow-y: auto;
        padding: 16px 12px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #000;
    }
    .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        max-width: 100%;
        animation: fadeIn 0.2s ease-out;
    }
    .msg-row.me { justify-content: flex-end; }
    .msg-row.other { justify-content: flex-start; }
    .msg-avatar {
        width: 32px; height: 32px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: 600; color: #fff;
        flex-shrink: 0;
    }
    .msg-row.me .msg-avatar { order: 2; background: var(--accent); }
    .msg-row.other .msg-avatar { order: 1; background: #444; }
    .bubble {
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.4;
        max-width: 75%;
        position: relative;
        word-wrap: break-word;
    }
    .msg-row.me .bubble {
        order: 1;
        background: var(--bubble-out);
        color: #fff;
        border-bottom-right-radius: 4px;
    }
    .msg-row.other .bubble {
        order: 2;
        background: var(--bubble-in);
        color: #ddd;
        border-bottom-left-radius: 4px;
    }
    .msg-row.monster .bubble {
        border: 1px solid var(--danger);
        color: #ffcccc;
        background: #1a0505;
    }
    .input-area {
        flex: 0 0 auto;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: #000;
    }
    .plus-btn {
        color: #b0b0b0;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        padding: 0 4px;
    }
    .input-wrapper {
        flex: 1;
        background: var(--input-bg);
        border-radius: 24px;
        display: flex;
        align-items: center;
        padding: 0 16px;
        min-height: 44px;
    }
    input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 16px;
        padding: 10px 0;
    }
    input::placeholder { color: #666; }
    #send-btn { display: none; }
    /* FX LAYERS */
    .fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 100; display: none; }
    #fx-glitch { background: rgba(255, 0, 0, 0.1); mix-blend-mode: difference; }
    #fx-face { background: #000; align-items: center; justify-content: center; z-index: 200; }
    .face-txt { font-size: 80px; filter: invert(1); animation: shake 0.05s infinite; }
    #fx-light { background: #fff; transition: opacity 2s; opacity: 0; z-index: 300; pointer-events: none; display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 0% { transform: translate(1px,1px); } 50% { transform: translate(-1px,-1px); } 100% { transform: translate(-1px,1px); } }
</style>
</head>
<body>
<div id="fx-glitch" class="fx-layer"></div>
<div id="fx-face" class="fx-layer" style="display:none; flex-direction:column"><div class="face-txt">‚ò†</div></div>
<div id="fx-light" class="fx-layer"></div>

<header>
    <div class="icon-btn">
        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    <div class="header-content">
        <div class="header-avatar">–ì</div>
        <div class="header-text">
            <h1>–ì–ª—É—Ö–∞—è –ì–∞—Ç—å</h1>
            <p id="status">4 —É—á–∞—Å—Ç–Ω–∏–∫–∞</p>
        </div>
    </div>
    <div class="icon-btn">
        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
    </div>
    <div class="icon-btn">
        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </div>
</header>

<div id="viewport"></div>

<div class="input-area">
    <div class="plus-btn">+</div>
    <div class="input-wrapper">
        <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
    </div>
</div>

<script>
class AudioEngine {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.master = this.ctx.createGain();
        this.master.connect(this.ctx.destination);
    }
    resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
    playTone(f, t, d) {
        this.resume();
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.frequency.value = f; o.type = t;
        g.gain.setValueAtTime(0.05, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + d);
        o.connect(g); g.connect(this.master);
        o.start(); o.stop(this.ctx.currentTime + d);
    }
    playPop() { this.playTone(600, 'sine', 0.1); }
    playScream() {
        this.resume();
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(200, t);
        o.frequency.linearRampToValueAtTime(1000, t+0.2);
        const g = this.ctx.createGain();
        g.gain.setValueAtTime(0.5, t);
        g.gain.exponentialRampToValueAtTime(0.01, t+0.5);
        o.connect(g); g.connect(this.master);
        o.start(); o.stop(t+0.5);
    }
    playGlitch() {
        this.resume();
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        o.type = 'square';
        o.frequency.setValueAtTime(100, t);
        o.frequency.linearRampToValueAtTime(50, t+0.1);
        const g = this.ctx.createGain();
        g.gain.setValueAtTime(0.2, t);
        g.gain.linearRampToValueAtTime(0, t+0.1);
        o.connect(g); g.connect(this.master);
        o.start(); o.stop(t+0.1);
    }
}

class UI {
    constructor() {
        this.view = document.getElementById('viewport');
        this.inp = document.getElementById('msg-input');
        this.status = document.getElementById('status');
        this.fx = {
            glitch: document.getElementById('fx-glitch'),
            face: document.getElementById('fx-face'),
            light: document.getElementById('fx-light')
        };
    }
    addMsg(data) {
        const row = document.createElement('div');
        row.className = `msg-row ${data.isMe ? 'me' : 'other'}`;
        if (data.id === 'monster') row.classList.add('monster');

        const av = document.createElement('div');
        av.className = 'msg-avatar';
        av.innerText = data.initial;
        
        if (data.id === 'monster') av.style.backgroundColor = '#ff0000';
        else if (!data.isMe) av.style.backgroundColor = data.color || '#444';

        const bub = document.createElement('div');
        bub.className = 'bubble';
        bub.innerText = data.text;

        row.appendChild(av);
        row.appendChild(bub);
        this.view.appendChild(row);
        this.view.scrollTop = this.view.scrollHeight;
    }
    setTyping(name) {
        this.status.innerText = `${name} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
        this.status.style.color = '#3e70dd';
    }
    resetStatus() {
        this.status.innerText = '4 —É—á–∞—Å—Ç–Ω–∏–∫–∞';
        this.status.style.color = '#888';
    }
    glitch() {
        this.fx.glitch.style.display = 'block';
        setTimeout(()=>this.fx.glitch.style.display='none', 150);
    }
    scream() {
        this.fx.face.style.display = 'flex';
        this.fx.face.querySelector('.face-txt').innerText = Math.random()>0.5 ? '‚ò†' : 'üëÅ';
        setTimeout(()=>this.fx.face.style.display='none', 200);
    }
    light() {
        this.fx.light.style.opacity = 1;
    }
}

class Net {
    constructor(k) {
        this.k = k;
        this.u = "https://openrouter.ai/api/v1/chat/completions";
    }
    async req(hist, temp) {
        try {
            const r = await fetch(this.u, {
                method:"POST",
                headers:{"Authorization":`Bearer ${this.k}`,"Content-Type":"application/json"},
                // –ò–ó–ú–ï–ù–ï–ù–û: –º–æ–¥–µ–ª—å –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ x-ai/grok-4.1-fast
                body:JSON.stringify({model:"x-ai/grok-4.1-fast",messages:hist,temperature:temp,max_tokens:120})
            });
            const d = await r.json();
            return d.choices[0].message.content;
        } catch(e) { return null; }
    }
}

class App {
    constructor() {
        this.audio = new AudioEngine();
        this.ui = new UI();
        // –í–ê–® –¢–ï–°–¢–û–í–´–ô –ö–õ–Æ–ß
        this.net = new Net("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");
        this.hist = [];
        
        this.agents = {
            alex: { id:'alex', name:'–ê–ª–µ–∫—Å', initial:'–ê', color:'#795548', sys:'–¢—ã –ê–ª–µ–∫—Å. –õ–∏–¥–µ—Ä. –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ.' },
            katya: { id:'katya', name:'–ö–∞—Ç—è', initial:'–ö', color:'#9c27b0', sys:'–¢—ã –ö–∞—Ç—è. –°–∫–µ–ø—Ç–∏–∫. –ë–æ–∏—à—å—Å—è.' },
            dan: { id:'dan', name:'–î—ç–Ω', initial:'–î', color:'#ff9800', sys:'–¢—ã –î—ç–Ω. –ü–∞–Ω–∏–∫–µ—Ä. –ö–ê–ü–°.' },
            monster: { id:'monster', name:'...', initial:'?', color:'#f44336', sys:'–¢—ã –ó–õ–û. –ö–æ–º–∞–Ω–¥—ã: [SCREAM], [GLITCH], [LIGHT].', temp:1.0 }
        };

        this.init();
    }

    init() {
        this.ui.inp.addEventListener('keydown', e => { if(e.key==='Enter') this.send(); });
        setTimeout(() => this.inject('alex', '–ù—É –∏ –≥–¥–µ –º—ã?'), 1000);
    }

    send() {
        const t = this.ui.inp.value.trim();
        if(!t) return;
        this.ui.inp.value = '';
        this.audio.playPop();
        this.ui.addMsg({ isMe:true, text:t, initial:'–Ø' });
        this.hist.push({ role:'user', content:`–ò–≥—Ä–æ–∫: ${t}` });
        this.process(t);
    }

    process(t) {
        let lower = t.toLowerCase();
        let tgts = [];
        
        if(lower.includes('–∞–ª–µ–∫—Å')) tgts.push('alex');
        else if(lower.includes('–∫–∞—Ç')) tgts.push('katya');
        else if(lower.includes('–¥—ç–Ω')) tgts.push('dan');
        else {
            let k = ['alex','katya','dan'];
            tgts.push(k[Math.floor(Math.random()*3)]);
        }

        let d = 1000;
        tgts.forEach(id => {
            setTimeout(()=>this.trigger(id), d);
            d += 2000;
        });

        if(Math.random()>0.7 || t.length>20) setTimeout(()=>this.trigger('monster'), d+500);
    }

    inject(id, txt) {
        this.ui.addMsg({ isMe:false, id:id, text:txt, initial:this.agents[id].initial, color:this.agents[id].color });
        this.hist.push({ role:'assistant', name:this.agents[id].name, content:txt });
        this.audio.playPop();
    }

    async trigger(id) {
        this.ui.setTyping(this.agents[id].name);
        const ctx = [{role:"system", content:this.agents[id].sys+" –ö–û–ù–¢–ï–ö–°–¢: –ù–æ—á—å, –±–æ–ª–æ—Ç–æ, —Ö–æ—Ä—Ä–æ—Ä."}, ...this.hist.slice(-10)];
        const res = await this.net.req(ctx, this.agents[id].temp||0.7);
        this.ui.resetStatus();
        
        if(res) {
            let clean = res;
            if(id==='monster') {
                if(res.includes('[SCREAM]')) { this.ui.scream(); this.audio.playScream(); clean=clean.replace('[SCREAM]',''); }
                if(res.includes('[GLITCH]')) { this.ui.glitch(); this.audio.playGlitch(); clean=clean.replace('[GLITCH]',''); }
                if(res.includes('[LIGHT]')) { this.ui.light(); clean="–°–í–ï–¢..."; }
            }
            if(clean.trim()) this.inject(id, clean);
        }
    }
}
window.onload = () => new App();
</script>
</body>
</html>
